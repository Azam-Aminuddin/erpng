{"docs":[{"fields":[{"collapsible":0,"no_copy":0,"creation":"2017-01-05 12:27:48.951036","search_fields":null,"doctype":"DocField","owner":"Administrator","in_list_view":1,"reqd":1,"ignore_xss_filter":0,"in_global_search":0,"read_only":0,"print_hide":0,"modified_by":"Administrator","ignore_user_permissions":0,"length":0,"label":"Assessment Plan","print_hide_if_no_value":0,"allow_bulk_edit":0,"linked_document_type":"Setup","set_only_once":0,"docstatus":0,"hidden":0,"in_filter":0,"permlevel":0,"columns":0,"bold":0,"parent":"Assessment Result Tool","search_index":0,"allow_on_submit":0,"precision":"","is_custom_field":null,"remember_last_selected_value":0,"unique":0,"name":"0611d06ce5","idx":1,"default":"","in_standard_filter":0,"modified":"2017-09-29 01:32:46.676163","parenttype":"DocType","fieldname":"assessment_plan","fieldtype":"Link","options":"Assessment Plan","report_hide":0,"parentfield":"fields"},{"collapsible":0,"no_copy":0,"creation":"2017-01-05 12:27:48.951036","search_fields":null,"doctype":"DocField","owner":"Administrator","in_list_view":0,"reqd":0,"ignore_xss_filter":0,"in_global_search":0,"read_only":0,"print_hide":0,"modified_by":"Administrator","ignore_user_permissions":0,"length":0,"print_hide_if_no_value":0,"allow_bulk_edit":0,"linked_document_type":null,"set_only_once":0,"docstatus":0,"hidden":0,"in_filter":0,"permlevel":0,"columns":0,"bold":0,"parent":"Assessment Result Tool","search_index":0,"allow_on_submit":0,"precision":"","is_custom_field":null,"remember_last_selected_value":0,"unique":0,"name":"520370e8db","idx":2,"in_standard_filter":0,"modified":"2017-09-29 01:32:46.676163","parenttype":"DocType","fieldname":"column_break_2","fieldtype":"Column Break","report_hide":0,"parentfield":"fields"},{"collapsible":0,"no_copy":0,"creation":"2017-01-05 12:27:48.951036","search_fields":["program","batch","course"],"doctype":"DocField","owner":"Administrator","in_list_view":1,"reqd":1,"ignore_xss_filter":0,"in_global_search":0,"read_only":1,"print_hide":0,"modified_by":"Administrator","ignore_user_permissions":0,"length":0,"label":"Student Group","print_hide_if_no_value":0,"allow_bulk_edit":0,"linked_document_type":"Document","set_only_once":0,"docstatus":0,"hidden":0,"in_filter":0,"permlevel":0,"columns":0,"bold":0,"parent":"Assessment Result Tool","search_index":0,"allow_on_submit":0,"precision":"","is_custom_field":null,"remember_last_selected_value":0,"unique":0,"name":"4dccd1749d","idx":3,"in_standard_filter":0,"modified":"2017-09-29 01:32:46.676163","parenttype":"DocType","fieldname":"student_group","fieldtype":"Link","options":"Student Group","report_hide":0,"parentfield":"fields"},{"collapsible":0,"no_copy":0,"creation":"2017-01-05 12:27:48.951036","search_fields":null,"doctype":"DocField","owner":"Administrator","in_list_view":0,"reqd":0,"ignore_xss_filter":0,"in_global_search":0,"read_only":0,"print_hide":0,"modified_by":"Administrator","ignore_user_permissions":0,"length":0,"print_hide_if_no_value":0,"allow_bulk_edit":0,"linked_document_type":null,"set_only_once":0,"depends_on":"assessment_plan","docstatus":0,"hidden":0,"in_filter":0,"permlevel":0,"columns":0,"bold":0,"parent":"Assessment Result Tool","search_index":0,"allow_on_submit":0,"precision":"","is_custom_field":null,"remember_last_selected_value":0,"unique":0,"name":"1bd279a7c7","idx":4,"in_standard_filter":0,"modified":"2017-09-29 01:32:46.676163","parenttype":"DocType","fieldname":"section_break_5","fieldtype":"Section Break","report_hide":0,"parentfield":"fields"},{"collapsible":0,"no_copy":0,"creation":"2017-01-05 12:27:48.951036","search_fields":null,"doctype":"DocField","owner":"Administrator","in_list_view":0,"reqd":0,"ignore_xss_filter":0,"in_global_search":0,"read_only":0,"print_hide":0,"modified_by":"Administrator","ignore_user_permissions":0,"length":0,"label":"Result HTML","print_hide_if_no_value":0,"allow_bulk_edit":0,"linked_document_type":null,"set_only_once":0,"docstatus":0,"hidden":0,"in_filter":0,"permlevel":0,"columns":0,"bold":0,"parent":"Assessment Result Tool","search_index":0,"allow_on_submit":0,"precision":"","is_custom_field":null,"remember_last_selected_value":0,"unique":0,"name":"61f8831a81","idx":5,"in_standard_filter":0,"modified":"2017-09-29 01:32:46.676163","parenttype":"DocType","fieldname":"result_html","fieldtype":"HTML","report_hide":0,"parentfield":"fields"}],"image_view":0,"allow_import":0,"creation":"2017-01-05 12:27:48.951036","__list_js":null,"track_changes":0,"track_seen":0,"sort_order":"DESC","__linked_with":null,"owner":"Administrator","editable_grid":1,"__form_grid_templates":null,"in_create":0,"read_only":0,"__templates":null,"document_type":"","hide_heading":1,"modified_by":"Administrator","allow_rename":0,"__kanban_column_fields":[],"custom":0,"max_attachments":0,"__js":"\n\n/* Adding /home/frappe/frappe-bench/apps/erpnext/erpnext/schools/doctype/assessment_result_tool/assessment_result_tool.js */\n\n// Copyright (c) 2016, Frappe Technologies Pvt. Ltd. and contributors\n// For license information, please see license.txt\n\n\nfrappe.ui.form.on('Assessment Result Tool', {\n\tsetup: function(frm) {\n\t\tfrm.add_fetch(\"assessment_plan\", \"student_group\", \"student_group\");\n\t},\n\n\trefresh: function(frm) {\n\t\tif (frappe.route_options) {\n\t\t\tfrm.set_value(\"student_group\", frappe.route_options.student_group);\n\t\t\tfrm.set_value(\"assessment_plan\", frappe.route_options.assessment_plan);\n\t\t\tfrappe.route_options = null;\n\t\t}\n\t\tfrm.disable_save();\n\t\tfrm.page.clear_indicator();\n\t\tfrm.trigger(\"assessment_plan\");\n\t},\n\n\tassessment_plan: function(frm) {\n\t\tfrm.doc.show_submit = false;\n\t\tif(frm.doc.assessment_plan) {\n\t\t\tif (!frm.doc.student_group)\n\t\t\t\treturn\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.schools.api.get_assessment_students\",\n\t\t\t\targs: {\n\t\t\t\t\t\"assessment_plan\": frm.doc.assessment_plan,\n\t\t\t\t\t\"student_group\": frm.doc.student_group\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tfrm.doc.students = r.message;\n\t\t\t\t\tfrm.events.render_table(frm);\n\t\t\t\t\tfor (let value of r.message) {\n\t\t\t\t\t\tif (!value.docstatus) {\n\t\t\t\t\t\t\tfrm.doc.show_submit = true;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tfrm.events.submit_result(frm);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\trender_table: function(frm) {\n\t\t$(frm.fields_dict.result_html.wrapper).empty();\n\t\tlet assessment_plan = frm.doc.assessment_plan;\n\t\tfrappe.call({\n\t\t\tmethod: \"erpnext.schools.api.get_assessment_details\",\n\t\t\targs: {\n\t\t\t\tassessment_plan: assessment_plan\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tfrm.events.get_marks(frm, r.message);\n\t\t\t}\n\t\t});\n\t},\n\n\tget_marks: function(frm, criteria_list) {\n\t\tlet max_total_score = 0;\n\t\tcriteria_list.forEach(function(c) {\n\t\t\tmax_total_score += c.maximum_score\n\t\t});\n\t\tvar result_table = $(frappe.render_template('assessment_result_tool', {\n\t\t\tfrm: frm,\n\t\t\tstudents: frm.doc.students,\n\t\t\tcriteria: criteria_list,\n\t\t\tmax_total_score: max_total_score\n\t\t}));\n\t\tresult_table.appendTo(frm.fields_dict.result_html.wrapper);\n\n\t\tresult_table.on('change', 'input', function(e) {\n\t\t\tlet $input = $(e.target);\n\t\t\tlet student = $input.data().student;\n\t\t\tlet max_score = $input.data().maxScore;\n\t\t\tlet value = $input.val();\n\t\t\tif(value < 0) {\n\t\t\t\t$input.val(0);\n\t\t\t} else if(value > max_score) {\n\t\t\t\t$input.val(max_score);\n\t\t\t}\n\t\t\tlet total_score = 0;\n\t\t\tlet student_scores = {};\n\t\t\tstudent_scores[\"assessment_details\"] = {}\n\t\t\tresult_table.find(`input[data-student=${student}].student-result-data`)\n\t\t\t\t.each(function(el, input) {\n\t\t\t\t\tlet $input = $(input);\n\t\t\t\t\tlet criteria = $input.data().criteria;\n\t\t\t\t\tlet value = parseFloat($input.val());\n\t\t\t\t\tif (value) {\n\t\t\t\t\t\tstudent_scores[\"assessment_details\"][criteria] = value;\n\t\t\t\t\t}\n\t\t\t\t\ttotal_score += value;\n\t\t\t});\n\t\t\tif(!Number.isNaN(total_score)) {\n\t\t\t\tresult_table.find(`span[data-student=${student}].total-score`).html(total_score);\n\t\t\t}\n\t\t\tif (Object.keys(student_scores[\"assessment_details\"]).length === criteria_list.length) {\n\t\t\t\tstudent_scores[\"student\"] = student;\n\t\t\t\tstudent_scores[\"total_score\"] = total_score;\n\t\t\t\tresult_table.find(`[data-student=${student}].result-comment`)\n\t\t\t\t\t.each(function(el, input){\n\t\t\t\t\tstudent_scores[\"comment\"] = $(input).val();\n\t\t\t\t});\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"erpnext.schools.api.mark_assessment_result\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\t\"assessment_plan\": frm.doc.assessment_plan,\n\t\t\t\t\t\t\"scores\": student_scores\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\tlet assessment_result = r.message;\n\t\t\t\t\t\tif (!frm.doc.show_submit) {\n\t\t\t\t\t\t\tfrm.doc.show_submit = true;\n\t\t\t\t\t\t\tfrm.events.submit_result;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tfor (var criteria of Object.keys(assessment_result.details)) {\n\t\t\t\t\t\t\tresult_table.find(`[data-criteria=${criteria}][data-student=${assessment_result\n\t\t\t\t\t\t\t\t.student}].student-result-grade`).each(function(e1, input) {\n\t\t\t\t\t\t\t\t\t$(input).html(assessment_result.details[criteria]);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tresult_table.find(`span[data-student=${assessment_result.student}].total-score-grade`).html(assessment_result.grade);\n\t\t\t\t\t\tlet link_span = result_table.find(`span[data-student=${assessment_result.student}].total-result-link`);\n\t\t\t\t\t\t$(link_span).css(\"display\", \"block\");\n\t\t\t\t\t\t$(link_span).find(\"a\").attr(\"href\", \"#Form/Assessment Result/\"+assessment_result.name);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\n\tsubmit_result: function(frm) {\n\t\tif (frm.doc.show_submit) {\n\t\t\tfrm.page.set_primary_action(__(\"Submit\"), function() {\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"erpnext.schools.api.submit_assessment_results\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\t\"assessment_plan\": frm.doc.assessment_plan,\n\t\t\t\t\t\t\"student_group\": frm.doc.student_group\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\tif (r.message) {\n\t\t\t\t\t\t\tfrappe.msgprint(__(\"{0} Result submittted\", [r.message]));\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tfrappe.msgprint(__(\"No Result to submit\"));\n\t\t\t\t\t\t}\n\t\t\t\t\t\tfrm.events.assessment_plan(frm);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\telse {\n\t\t\tfrm.page.clear_primary_action();\n\t\t}\n\t}\n});\n","__tree_js":null,"docstatus":0,"sort_field":"modified","__messages":null,"allow_copy":1,"engine":"InnoDB","allow_guest_to_view":0,"istable":0,"has_web_view":0,"__map_js":null,"__css":null,"show_name_in_global_search":0,"beta":0,"read_only_onload":0,"module":"Schools","doctype":"DocType","__dashboard":{},"__kanban_boards":[],"issingle":1,"__listview_template":null,"name":"Assessment Result Tool","idx":0,"hide_toolbar":1,"__workflow_docs":[],"modified":"2017-06-30 08:21:47.184562","is_submittable":0,"name_case":"","__calendar_js":null,"restrict_to_domain":"Education","permissions":[{"creation":"2017-01-05 12:27:48.951036","share":1,"doctype":"DocPerm","owner":"Administrator","export":0,"cancel":0,"set_user_permissions":0,"modified_by":"Administrator","create":1,"submit":0,"write":1,"role":"Academics User","print":1,"docstatus":0,"permlevel":0,"parent":"Assessment Result Tool","read":1,"import":0,"report":0,"apply_user_permissions":0,"name":"ab8e71339f","idx":1,"amend":0,"modified":"2017-09-29 01:32:46.676163","email":1,"parenttype":"DocType","parentfield":"permissions","if_owner":0,"delete":0}],"quick_entry":1,"__custom_js":"","__print_formats":[]}],"user_settings":"{}"}