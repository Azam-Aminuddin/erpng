{"docs":[{"system_page":0,"parent":null,"creation":"2013-10-04 13:17:18","module":"Selling","standard":"Yes","doctype":"Page","owner":"Administrator","icon":"fa fa-filter","style":".funnel-wrapper {\n\tmargin: 15px;\n}","modified_by":"Administrator","name":"sales-funnel","roles":[{"modified_by":"Administrator","name":null,"parent":"sales-funnel","creation":"2013-10-04 13:17:18","modified":"2017-06-09 23:51:51.383396","doctype":"Has Role","idx":1,"parenttype":"Page","role":"Sales Manager","owner":"Administrator","docstatus":0,"parentfield":"roles"}],"script":"// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nfrappe.pages['sales-funnel'].on_page_load = function(wrapper) {\n\tfrappe.ui.make_app_page({\n\t\tparent: wrapper,\n\t\ttitle: __('Sales Funnel'),\n\t\tsingle_column: true\n\t});\n\n\twrapper.sales_funnel = new erpnext.SalesFunnel(wrapper);\n\n\tfrappe.breadcrumbs.add(\"Selling\");\n}\n\nerpnext.SalesFunnel = Class.extend({\n\tinit: function(wrapper) {\n\t\tvar me = this;\n\t\t// 0 setTimeout hack - this gives time for canvas to get width and height\n\t\tsetTimeout(function() {\n\t\t\tme.setup(wrapper);\n\t\t\tme.get_data();\n\t\t}, 0);\n\t},\n\n\tsetup: function(wrapper) {\n\t\tvar me = this;\n\n\t\tthis.elements = {\n\t\t\tlayout: $(wrapper).find(\".layout-main\"),\n\t\t\tfrom_date: wrapper.page.add_date(__(\"From Date\")),\n\t\t\tto_date: wrapper.page.add_date(__(\"To Date\")),\n\t\t\trefresh_btn: wrapper.page.set_primary_action(__(\"Refresh\"),\n\t\t\t\tfunction() { me.get_data(); }, \"fa fa-refresh\"),\n\t\t};\n\n\t\tthis.elements.no_data = $('<div class=\"alert alert-warning\">' + __(\"No Data\") + '</div>')\n\t\t\t.toggle(false)\n\t\t\t.appendTo(this.elements.layout);\n\n\t\tthis.elements.funnel_wrapper = $('<div class=\"funnel-wrapper text-center\"></div>')\n\t\t\t.appendTo(this.elements.layout);\n\n\t\tthis.options = {\n\t\t\tfrom_date: frappe.datetime.add_months(frappe.datetime.get_today(), -1),\n\t\t\tto_date: frappe.datetime.get_today()\n\t\t};\n\n\t\t// set defaults and bind on change\n\t\t$.each(this.options, function(k, v) {\n\t\t\tme.elements[k].val(frappe.datetime.str_to_user(v));\n\t\t\tme.elements[k].on(\"change\", function() {\n\t\t\t\tme.options[k] = frappe.datetime.user_to_str($(this).val());\n\t\t\t\tme.get_data();\n\t\t\t});\n\t\t});\n\n\t\t// bind refresh\n\t\tthis.elements.refresh_btn.on(\"click\", function() {\n\t\t\tme.get_data(this);\n\t\t});\n\n\t\t// bind resize\n\t\t$(window).resize(function() {\n\t\t\tme.render();\n\t\t});\n\t},\n\n\tget_data: function(btn) {\n\t\tvar me = this;\n\t\tfrappe.call({\n\t\t\tmethod: \"erpnext.selling.page.sales_funnel.sales_funnel.get_funnel_data\",\n\t\t\targs: {\n\t\t\t\tfrom_date: this.options.from_date,\n\t\t\t\tto_date: this.options.to_date\n\t\t\t},\n\t\t\tbtn: btn,\n\t\t\tcallback: function(r) {\n\t\t\t\tif(!r.exc) {\n\t\t\t\t\tme.options.data = r.message;\n\t\t\t\t\tme.render();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\trender: function() {\n\t\tvar me = this;\n\t\tthis.prepare();\n\n\t\tvar context = this.elements.context,\n\t\t\tx_start = 0.0,\n\t\t\tx_end = this.options.width,\n\t\t\tx_mid = (x_end - x_start) / 2.0,\n\t\t\ty = 0,\n\t\t\ty_old = 0.0;\n\n\t\tif(this.options.total_value === 0) {\n\t\t\tthis.elements.no_data.toggle(true);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.options.data.forEach(function(d) {\n\t\t\tcontext.fillStyle = d.color;\n\t\t\tcontext.strokeStyle = d.color;\n\t\t\tme.draw_triangle(x_start, x_mid, x_end, y, me.options.height);\n\n\t\t\ty_old = y;\n\n\t\t\t// new y\n\t\t\ty = y + d.height;\n\n\t\t\t// new x\n\t\t\tvar half_side = (me.options.height - y) / Math.sqrt(3);\n\t\t\tx_start = x_mid - half_side;\n\t\t\tx_end = x_mid + half_side;\n\n\t\t\tvar y_mid = y_old + (y - y_old) / 2.0;\n\n\t\t\tme.draw_legend(x_mid, y_mid, me.options.width, me.options.height, d.value + \" - \" + d.title);\n\t\t});\n\t},\n\n\tprepare: function() {\n\t\tvar me = this;\n\n\t\tthis.elements.no_data.toggle(false);\n\n\t\t// calculate width and height options\n\t\tthis.options.width = $(this.elements.funnel_wrapper).width() * 2.0 / 3.0;\n\t\tthis.options.height = (Math.sqrt(3) * this.options.width) / 2.0;\n\n\t\t// calculate total weightage\n\t\t// as height decreases, area decreases by the square of the reduction\n\t\t// hence, compensating by squaring the index value\n\t\tthis.options.total_weightage = this.options.data.reduce(\n\t\t\tfunction(prev, curr, i) { return prev + Math.pow(i+1, 2) * curr.value; }, 0.0);\n\n\t\t// calculate height for each data\n\t\t$.each(this.options.data, function(i, d) {\n\t\t\td.height = me.options.height * d.value * Math.pow(i+1, 2) / me.options.total_weightage;\n\t\t});\n\n\t\tthis.elements.canvas = $('<canvas></canvas>')\n\t\t\t.appendTo(this.elements.funnel_wrapper.empty())\n\t\t\t.attr(\"width\", $(this.elements.funnel_wrapper).width())\n\t\t\t.attr(\"height\", this.options.height);\n\n\t\tthis.elements.context = this.elements.canvas.get(0).getContext(\"2d\");\n\t},\n\n\tdraw_triangle: function(x_start, x_mid, x_end, y, height) {\n\t\tvar context = this.elements.context;\n\t\tcontext.beginPath();\n\t\tcontext.moveTo(x_start, y);\n\t\tcontext.lineTo(x_end, y);\n\t\tcontext.lineTo(x_mid, height);\n\t\tcontext.lineTo(x_start, y);\n\t\tcontext.closePath();\n\t\tcontext.fill();\n\t},\n\n\tdraw_legend: function(x_mid, y_mid, width, height, title) {\n\t\tvar context = this.elements.context;\n\n\t\tif(y_mid == 0) {\n\t\t\ty_mid = 7;\n\t\t}\n\n\t\t// draw line\n\t\tcontext.beginPath();\n\t\tcontext.moveTo(x_mid, y_mid);\n\t\tcontext.lineTo(width, y_mid);\n\t\tcontext.closePath();\n\t\tcontext.stroke();\n\n\t\t// draw circle\n\t\tcontext.beginPath();\n\t\tcontext.arc(width, y_mid, 5, 0, Math.PI * 2, false);\n\t\tcontext.closePath();\n\t\tcontext.fill();\n\n\t\t// draw text\n\t\tcontext.fillStyle = \"black\";\n\t\tcontext.textBaseline = \"middle\";\n\t\tcontext.font = \"1.1em sans-serif\";\n\t\tcontext.fillText(__(title), width + 20, y_mid);\n\t}\n});\n","title":"Sales Funnel","restrict_to_domain":null,"modified":"2013-10-04 13:17:18","content":null,"idx":1,"parenttype":null,"page_name":"sales-funnel","docstatus":0,"parentfield":null}]}