{"docs":[{"system_page":0,"parent":null,"creation":"2012-06-14 18:44:56","_dynamic_page":1,"module":"Desk","standard":"Yes","doctype":"Page","owner":"Administrator","icon":"","style":".message-row .bot-icon {\n\twidth: 24px;\n\tmargin-right: 5px;\n\tpadding-left: 7px;\n\tfont-size: 18px;\n\t/*color: #FEEF72;*/\n}\n\n\n.message-bubble {\n\tpadding: 0px 10px;\n\tpadding-top: 2px;\n\tborder-radius: 10px;\n\tmargin-bottom: 10px;\n\tbackground-color: #d1d8dd;\n\twidth: 70%;\n}\n\n.message-bubble::before {\n    background-color: #d1d8dd;\n    content: \"\\00a0\";\n    display: block;\n    height: 6px;\n    position: absolute;\n    top: 7px;\n\tleft: 70px;\n    transform:             rotate( 45deg ) skew( -35deg );\n        -moz-transform:    rotate( 45deg ) skew( -35deg );\n        -ms-transform:     rotate( 45deg ) skew( -35deg );\n        -o-transform:      rotate( 45deg ) skew( -35deg );\n        -webkit-transform: rotate( 45deg ) skew( -35deg );\n    width:  14px;\n}\n\n.message-bubble.my-message {\n\tcolor: white;\n    background-color: #5E64FF;\n}\n\n.message-bubble.my-message::before {\n    background-color: #5E64FF;\n}","modified_by":"Administrator","name":"chat","roles":[{"modified_by":"Administrator","name":null,"parent":"chat","creation":"2012-06-14 18:44:56","modified":"2017-06-09 23:47:43.906019","doctype":"Has Role","idx":1,"parenttype":"Page","role":"All","owner":"Administrator","docstatus":0,"parentfield":"roles"}],"script":"frappe.templates[\"chat_row\"] = '<div class=\"row message-row small\"> <div class=\"col-sm-9\"> <div class=\"media\"> {% if (data.is_public) { %} <span class=\"pull-left hidden-xs\" title=\"{{ __(\"Public\") }}\"> <i class=\"octicon octicon-rss text-muted\" style=\"margin-top: 3px;\"></i></span> {% } else { %} <span class=\"pull-left hidden-xs\" style=\"width: 20px; height: 16px; display: inline-block;\"></span> {% } %} <div class=\"pull-left hidden-xs\"> <span class=\"avatar avatar-small\" title=\"{%= frappe.user.full_name(data.owner) %} \"> <img class=\"media-object {{ data.is_system_message ? \"grayscale\" : \"\" }}\" src=\"{%= frappe.user.image(data.owner) %}\"> </span> </div> <div class=\"media-body {{ data.is_system_message ? \"system-message\" : \"\" }} message-bubble {{ data.is_mine ? \"my-message\" : \"\" }}\"> {%= data.content %} </div> </div> </div> <div class=\"col-sm-3 text-right message-row-right\"> <div class=\"text-muted\"> <span class=\"hidden-sm hidden-md hidden-lg\"> {%= frappe.user.full_name(data.owner) %}, </span> {%= comment_when(data.modified) %} </div> {% if (data.owner==user) { %} <div> <a class=\"delete text-extra-muted\" data-name=\"{%= data.name %}\" onclick=\"frappe.desk.pages.messages.delete(this)\">Delete</a> </div> {% } %} </div> </div> ';\nfrappe.templates[\"chat_sidebar\"] = '<ul class=\"nav nav-pills nav-stacked\"> {% for (var i=0, l= data.length; i < l; i++) { var contact = data[i]; %} <li data-user=\"{%= contact.name %}\" class=\"h6 module-sidebar-item\"> <a class=\"messages-sidebar-link ellipsis\"> <span class=\"indicator {% if(contact.has_session > 0) { %} green {% } else { %} grey {% } %}\"> <span class=\"avatar avatar-small hidden-sm hidden-md hidden-lg\" title=\"{%= frappe.user.full_name(contact.name) %} \"> <img class=\"media-object\" src=\"{%= frappe.user.image(contact.name) %}\"> </span> <span class=\"hidden-xs\">{%= contact.name===user ? __(\"Everyone\") : frappe.user.full_name(contact.name) %}</span> </span> </a> </li> {% } %} </ul> ';\nfrappe.templates[\"chat_main\"] = '<div class=\"message-box\"> <div class=\"media timeline-head\"> <span class=\"pull-left avatar avatar-medium hidden-xs\"> <img class=\"media-object\" src=\"{%= frappe.user.image() %}\"> </span> <div class=\"media-body\"> <textarea style=\"height: 120px\" style=\"margin-top: 10px;\" class=\"form-control messages-textarea\"></textarea> </div> <div style=\"padding-top: 15px;\"> <span class=\"text-muted small hidden-xs\" style=\"margin-left: 45px;\">{{ __(\"Ctrl + Enter to post\") }}</span> <button class=\"pull-right btn btn-primary btn-sm btn-post\" data-contact=\"{%= contact %}\"> {%= __(\"Post\") %} </button> {% if (contact === user) { %} <span class=\"pull-right\" style=\"margin-top: 4px; margin-right: 10px;\"> <i class=\"octicon octicon-rss\"></i> <span class=\"text-muted small\">{%= __(\"Public\") %}</span> </span> {% } %} <div class=\"pull-right checkbox text-muted small\" style=\"margin-right: 15px; margin-top: 7px;\"> <label> <input type=\"checkbox\" class=\"is-email\" style=\"margin-top: 1px\"> {%= __(\"Email\") %} </label> </div> <div class=\"clearfix\"></div> </div> </div> </div> <div class=\"message-list\"></div> ';\n// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// MIT License. See license.txt\n\nfrappe.pages.chat.on_page_load = function(parent) {\n\tvar page = frappe.ui.make_app_page({\n\t\tparent: parent,\n\t});\n\n\tpage.set_title('<span class=\"hidden-xs\">' + __(\"Chat\") + '</span>'\n\t\t+ '<span class=\"hidden-sm hidden-md hidden-lg message-to\"></span>');\n\n\t$(\".navbar-center\").html(__(\"Chat\"));\n\n\tfrappe.pages.chat.chat = new frappe.Chat(parent);\n}\n\nfrappe.pages.chat.on_page_show = function() {\n\t// clear title prefix\n\tfrappe.utils.set_title_prefix(\"\");\n\n\tfrappe.breadcrumbs.add(\"Desk\");\n}\n\nfrappe.Chat = Class.extend({\n\tinit: function(wrapper, page) {\n\t\tthis.wrapper = wrapper;\n\t\tthis.page = wrapper.page;\n\t\tthis.make();\n\t\tthis.page.sidebar.addClass(\"col-sm-3\");\n\t\tthis.page.wrapper.find(\".layout-main-section-wrapper\").addClass(\"col-sm-9\");\n\t\tthis.page.wrapper.find(\".page-title\").removeClass(\"col-xs-6\").addClass(\"col-xs-12\");\n\t\tthis.page.wrapper.find(\".page-actions\").removeClass(\"col-xs-6\").addClass(\"hidden-xs\");\n\t\tthis.setup_realtime();\n\t},\n\n\tmake: function() {\n\t\tthis.make_sidebar();\n\t},\n\n\tsetup_realtime: function() {\n\t\tvar me = this;\n\t\tfrappe.realtime.on('new_message', function(comment) {\n\t\t\tif(comment.modified_by !== frappe.session.user || comment.communication_type === 'Bot') {\n\t\t\t\tif(frappe.get_route()[0] === 'chat') {\n\t\t\t\t\tvar current_contact = $(cur_page.page).find('[data-contact]').data('contact');\n\t\t\t\t\tvar on_broadcast_page = current_contact === frappe.session.user;\n\t\t\t\t\tif ((current_contact == comment.owner)\n\t\t\t\t\t\t|| (on_broadcast_page && comment.broadcast)\n\t\t\t\t\t\t|| current_contact === 'Bot' && comment.communication_type === 'Bot') {\n\n\t\t\t\t\t\tsetTimeout(function() { me.prepend_comment(comment); }, 1000);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tfrappe.utils.notify(__(\"Message from {0}\", [frappe.user_info(comment.owner).fullname]), comment.content);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tprepend_comment: function(comment) {\n\t\tfrappe.pages.chat.chat.list.data.unshift(comment);\n\t\tthis.render_row(comment, true);\n\t},\n\n\tmake_sidebar: function() {\n\t\tvar me = this;\n\t\treturn frappe.call({\n\t\t\tmodule:'frappe.desk',\n\t\t\tpage:'chat',\n\t\t\tmethod:'get_active_users',\n\t\t\tcallback: function(r,rt) {\n\t\t\t\t// sort\n\t\t\t\tr.message.sort(function(a, b) { return cint(b.has_session) - cint(a.has_session); });\n\n\t\t\t\t// render\n\t\t\t\tme.page.sidebar.html(frappe.render_template(\"chat_sidebar\", {data: r.message}));\n\n\t\t\t\t// bind click\n\t\t\t\tme.page.sidebar.find(\"a\").on(\"click\", function() {\n\t\t\t\t\tvar li = $(this).parents(\"li:first\");\n\t\t\t\t\tif (li.hasClass(\"active\"))\n\t\t\t\t\t\treturn false;\n\n\t\t\t\t\tvar contact = li.attr(\"data-user\");\n\n\t\t\t\t\t// active\n\t\t\t\t\tme.page.sidebar.find(\"li.active\").removeClass(\"active\");\n\t\t\t\t\tme.page.sidebar.find('[data-user=\"'+ contact +'\"]').addClass(\"active\");\n\n\t\t\t\t\tme.make_messages(contact);\n\t\t\t\t});\n\n\t\t\t\t$(me.page.sidebar.find(\"a\")[0]).click();\n\t\t\t}\n\t\t});\n\t},\n\n\tmake_messages: function(contact) {\n\t\tvar me = this;\n\n\t\tthis.page.main.html($(frappe.render_template(\"chat_main\", { \"contact\": contact })));\n\n\t\tvar text_area = this.page.main.find(\".messages-textarea\").on(\"focusout\", function() {\n\t\t\t// on touchscreen devices, scroll to top\n\t\t\t// so that static navbar and page head don't overlap the textarea\n\t\t\tif (frappe.dom.is_touchscreen()) {\n\t\t\t\tfrappe.utils.scroll_to($(this).parents(\".message-box\"));\n\t\t\t}\n\t\t});\n\n\n\t\tvar post_btn = this.page.main.find(\".btn-post\").on(\"click\", function() {\n\t\t\tvar btn = $(this);\n\t\t\tvar message_box = btn.parents(\".message-box\");\n\t\t\tvar textarea = message_box.find(\"textarea\");\n\t\t\tvar contact = btn.attr(\"data-contact\");\n\t\t\tvar txt = textarea.val();\n\t\t\tvar send_email = message_box.find('input[type=\"checkbox\"]:checked').length > 0;\n\n\t\t\tif(txt) {\n\t\t\t\treturn frappe.call({\n\t\t\t\t\tmodule: 'frappe.desk',\n\t\t\t\t\tpage:'chat',\n\t\t\t\t\tmethod:'post',\n\t\t\t\t\targs: {\n\t\t\t\t\t\ttxt: txt,\n\t\t\t\t\t\tcontact: contact,\n\t\t\t\t\t\tnotify: send_email ? 1 : 0\n\t\t\t\t\t},\n\t\t\t\t\tcallback:function(r,rt) {\n\t\t\t\t\t\ttextarea.val('');\n\t\t\t\t\t\tif (!r.exc) {\n\t\t\t\t\t\t\tme.prepend_comment(r.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tbtn: this\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\ttext_area.keydown(\"meta+return ctrl+return\", function(e) {\n\t\t\tpost_btn.trigger(\"click\");\n\t\t});\n\n\t\tthis.page.wrapper.find(\".page-head .message-to\").html(frappe.user.full_name(contact));\n\n\t\tthis.make_message_list(contact);\n\n\t\tthis.list.run();\n\n\t\tfrappe.utils.scroll_to();\n\t},\n\n\tmake_message_list: function(contact) {\n\t\tvar me = this;\n\n\t\tthis.list = new frappe.ui.BaseList({\n\t\t\tparent: this.page.main.find(\".message-list\"),\n\t\t\tpage: this.page,\n\t\t\tmethod: 'frappe.desk.page.chat.chat.get_list',\n\t\t\targs: {\n\t\t\t\tcontact: contact\n\t\t\t},\n\t\t\thide_refresh: true,\n\t\t\tfreeze: false,\n\t\t\trender_view: function (values) {\n\t\t\t\tvalues.map(function (value) {\n\t\t\t\t\tme.render_row(value);\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\t},\n\n\trender_row: function(value, prepend) {\n\t\tthis.prepare(value)\n\n\t\tvar wrapper = $('<div class=\"list-row\">')\n\t\t\t.data(\"data\", this.meta)\n\n\t\tif(!prepend)\n\t\t\twrapper.appendTo($(\".result-list\")).get(0);\n\t\telse\n\t\t\twrapper.prependTo($(\".result-list\")).get(0);\n\n\t\tvar row = $(frappe.render_template(\"chat_row\", {\n\t\t\tdata: value\n\t\t})).appendTo(wrapper)\n\t\trow.find(\".avatar, .indicator\").tooltip();\n\t},\n\n\tdelete: function(ele) {\n\t\t$(ele).parent().css('opacity', 0.6);\n\t\treturn frappe.call({\n\t\t\tmethod: 'frappe.desk.page.chat.chat.delete',\n\t\t\targs: {name : $(ele).attr('data-name')},\n\t\t\tcallback: function() {\n\t\t\t\t$(ele).parents(\".list-row:first\").toggle(false);\n\t\t\t}\n\t\t});\n\t},\n\n\trefresh: function() {},\n\n\tget_contact: function() {\n\t\tvar route = location.hash;\n\t\tif(route.indexOf('/')!=-1) {\n\t\t\tvar name = decodeURIComponent(route.split('/')[1]);\n\t\t\tif(name.indexOf('__at__')!=-1) {\n\t\t\t\tname = name.replace('__at__', '@');\n\t\t\t}\n\t\t\treturn name;\n\t\t}\n\t},\n\n\tprepare: function(data) {\n\t\tif(data.communication_type===\"Notification\" || data.comment_type===\"Shared\") {\n\t\t\tdata.is_system_message = 1;\n\t\t}\n\n\t\tif(data.owner==data.reference_name\n\t\t\t&& data.communication_type!==\"Notification\"\n\t\t\t&& data.comment_type!==\"Bot\") {\n\t\t\tdata.is_public = true;\n\t\t}\n\n\t\tif(data.owner==data.reference_name && data.communication_type !== \"Bot\") {\n\t\t\tdata.is_mine = true;\n\t\t}\n\n\t\tif(data.owner==data.reference_name && data.communication_type === \"Bot\") {\n\t\t\tdata.owner = 'bot';\n\t\t}\n\n\t\tdata.content = frappe.markdown(data.content.substr(0, 1000));\n\t}\n\n\n\n});\n","title":"Chat","restrict_to_domain":null,"modified":"2016-03-31 02:02:13.503910","content":null,"idx":1,"parenttype":null,"page_name":"chat","docstatus":0,"parentfield":null}]}