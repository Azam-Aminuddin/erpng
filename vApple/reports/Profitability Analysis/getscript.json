{"message":{"html_format":"{%\n\tif (report.columns.length > 8) {\n\t\tfrappe.throw(__(\"Too many columns. Export the report and print it using a spreadsheet application.\"));\n\t}\n%}\n\n<style>\n\t.financial-statements-important td {\n\t\tfont-weight: bold;\n\t}\n\n\t.financial-statements-blank-row td {\n\t\theight: 37px;\n\t}\n</style>\n{% var letterhead= filters.letter_head || (frappe.get_doc(\":Company\", filters.company) && frappe.get_doc(\":Company\", filters.company).default_letter_head) || frappe.defaults.get_default(\"letter_head\"); %}\n{% if(letterhead) { %} \n<div style=\"margin-bottom: 7px;\" class=\"text-center\">\n\t{%= frappe.boot.letter_heads[letterhead].header %}\n</div>\n{% } %}\n<h2 class=\"text-center\">{%= __(report.report_name) %}</h2>\n<h3 class=\"text-center\">{%= filters.company %}</h3>\n<h3 class=\"text-center\">{%= filters.fiscal_year %}</h3>\n<h5 class=\"text-center\">{%=  __(\"Currency\") %} : {%= erpnext.get_currency(filters.company) %} </h4>\n{% if (filters.from_date) { %}\n\t<h4 class=\"text-center\">{%= dateutil.str_to_user(filters.from_date) %} - {%= dateutil.str_to_user(filters.to_date) %}</h3>\n{% } %}\n<hr>\n<table class=\"table table-bordered\">\n\t<thead>\n\t\t<tr>\n\t\t\t<th style=\"width: {%= 100 - (report.columns.length - 2) * 13 %}%\"></th>\n\t\t\t{% for(var i=2, l=report.columns.length; i<l; i++) { %}\n\t\t\t\t<th class=\"text-right\">{%= report.columns[i].label %}</th>\n\t\t\t{% } %}\n\t\t</tr>\n\t</thead>\n\t<tbody>\n\t\t{% for(var j=0, k=data.length; j<k; j++) { %}\n\t\t\t{%\n\t\t\t\tvar row = data[j];\n\t\t\t\tvar row_class = data[j].parent_account ? \"\" : \"financial-statements-important\";\n\t\t\t\trow_class += data[j].account_name ? \"\" : \" financial-statements-blank-row\";\n\t\t\t%}\n\t\t\t<tr class=\"{%= row_class %}\">\n\t\t\t\t<td>\n\t\t\t\t\t<span style=\"padding-left: {%= cint(data[j].indent) * 2 %}em\">{%= row.account_name %}</span>\n\t\t\t\t</td>\n\t\t\t\t{% for(var i=2, l=report.columns.length; i<l; i++) { %}\n\t\t\t\t\t<td class=\"text-right\">\n\t\t\t\t\t\t{% var fieldname = report.columns[i].field; %}\n\t\t\t\t\t\t{% if (!is_null(row[fieldname])) { %}\n\t\t\t\t\t\t\t{%= format_number(row[fieldname], null)%}\n\t\t\t\t\t\t{% } %}\n\t\t\t\t\t</td>\n\t\t\t\t{% } %}\n\t\t\t</tr>\n\t\t{% } %}\n\t</tbody>\n</table>\n<p class=\"text-right text-muted\">Printed On {%= dateutil.str_to_user(dateutil.get_datetime_as_string()) %}</p>\n","script":"// Copyright (c) 2016, Frappe Technologies Pvt. Ltd. and contributors\n// For license information, please see license.txt\n\nfrappe.require(\"assets/erpnext/js/financial_statements.js\", function() {\n\tfrappe.query_reports[\"Profitability Analysis\"] = {\n\t\t\"filters\": [\n\t\t\t{\n\t\t\t\t\"fieldname\": \"company\",\n\t\t\t\t\"label\": __(\"Company\"),\n\t\t\t\t\"fieldtype\": \"Link\",\n\t\t\t\t\"options\": \"Company\",\n\t\t\t\t\"default\": frappe.defaults.get_user_default(\"Company\"),\n\t\t\t\t\"reqd\": 1\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"fieldname\": \"based_on\",\n\t\t\t\t\"label\": __(\"Based On\"),\n\t\t\t\t\"fieldtype\": \"Select\",\n\t\t\t\t\"options\": \"Cost Center\\nProject\",\n\t\t\t\t\"default\": \"Cost Center\",\n\t\t\t\t\"reqd\": 1\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"fieldname\": \"fiscal_year\",\n\t\t\t\t\"label\": __(\"Fiscal Year\"),\n\t\t\t\t\"fieldtype\": \"Link\",\n\t\t\t\t\"options\": \"Fiscal Year\",\n\t\t\t\t\"default\": frappe.defaults.get_user_default(\"fiscal_year\"),\n\t\t\t\t\"reqd\": 1,\n\t\t\t\t\"on_change\": function(query_report) {\n\t\t\t\t\tvar fiscal_year = query_report.get_values().fiscal_year;\n\t\t\t\t\tif (!fiscal_year) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tfrappe.model.with_doc(\"Fiscal Year\", fiscal_year, function(r) {\n\t\t\t\t\t\tvar fy = frappe.model.get_doc(\"Fiscal Year\", fiscal_year);\n\t\t\t\t\t\tfrappe.query_report_filters_by_name.from_date.set_input(fy.year_start_date);\n\t\t\t\t\t\tfrappe.query_report_filters_by_name.to_date.set_input(fy.year_end_date);\n\t\t\t\t\t\tquery_report.trigger_refresh();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"fieldname\": \"from_date\",\n\t\t\t\t\"label\": __(\"From Date\"),\n\t\t\t\t\"fieldtype\": \"Date\",\n\t\t\t\t\"default\": frappe.defaults.get_user_default(\"year_start_date\"),\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"fieldname\": \"to_date\",\n\t\t\t\t\"label\": __(\"To Date\"),\n\t\t\t\t\"fieldtype\": \"Date\",\n\t\t\t\t\"default\": frappe.defaults.get_user_default(\"year_end_date\"),\n\t\t\t},\n\t\t\t{\n\t\t\t\t\"fieldname\": \"show_zero_values\",\n\t\t\t\t\"label\": __(\"Show zero values\"),\n\t\t\t\t\"fieldtype\": \"Check\"\n\t\t\t}\n\t\t],\n\t\t\"formatter\": function(row, cell, value, columnDef, dataContext, default_formatter) {\n\t\t\tif (columnDef.df.fieldname==\"account\") {\n\t\t\t\tvalue = dataContext.account_name;\n\n\t\t\t\tcolumnDef.df.link_onclick =\n\t\t\t\t\t\"frappe.query_reports['Profitability Analysis'].open_profit_and_loss_statement(\" + JSON.stringify(dataContext) + \")\";\n\t\t\t\tcolumnDef.df.is_tree = true;\n\t\t\t}\n\n\t\t\tvalue = default_formatter(row, cell, value, columnDef, dataContext);\n\n\t\t\tif (!dataContext.parent_account && dataContext.based_on != 'project') {\n\t\t\t\tvar $value = $(value).css(\"font-weight\", \"bold\");\n\t\t\t\tif (dataContext.warn_if_negative && dataContext[columnDef.df.fieldname] < 0) {\n\t\t\t\t\t$value.addClass(\"text-danger\");\n\t\t\t\t}\n\n\t\t\t\tvalue = $value.wrap(\"<p></p>\").parent().html();\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\t\t\"open_profit_and_loss_statement\": function(data) {\n\t\t\tif (!data.account) return;\n\n\t\t\tfrappe.route_options = {\n\t\t\t\t\"company\": frappe.query_report_filters_by_name.company.get_value(),\n\t\t\t\t\"from_fiscal_year\": data.fiscal_year,\n\t\t\t\t\"to_fiscal_year\": data.fiscal_year\n\t\t\t};\n\n\t\t\tif(data.based_on == 'cost_center'){\n\t\t\t\tfrappe.route_options[\"cost_center\"] = data.account\n\t\t\t} else {\n\t\t\t\tfrappe.route_options[\"project\"] = data.account\n\t\t\t}\n\n\t\t\tfrappe.set_route(\"query-report\", \"Profit and Loss Statement\");\n\t\t},\n\t\t\"tree\": true,\n\t\t\"name_field\": \"account\",\n\t\t\"parent_field\": \"parent_account\",\n\t\t\"initial_depth\": 3\n\t}\n});\n\n"}}