{"message":{"script":"// Copyright (c) 2016, Frappe Technologies Pvt. Ltd. and contributors\r\n// For license information, please see license.txt\r\n\r\nfrappe.require(\"assets/erpnext/js/financial_statements.js\", function() {\r\n\tfrappe.query_reports[\"Profitability Analysis\"] \u003d {\r\n\t\t\"filters\": [\r\n\t\t\t{\r\n\t\t\t\t\"fieldname\": \"company\",\r\n\t\t\t\t\"label\": __(\"Company\"),\r\n\t\t\t\t\"fieldtype\": \"Link\",\r\n\t\t\t\t\"options\": \"Company\",\r\n\t\t\t\t\"default\": frappe.defaults.get_user_default(\"Company\"),\r\n\t\t\t\t\"reqd\": 1\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"fieldname\": \"based_on\",\r\n\t\t\t\t\"label\": __(\"Based On\"),\r\n\t\t\t\t\"fieldtype\": \"Select\",\r\n\t\t\t\t\"options\": \"Cost Center\\nProject\",\r\n\t\t\t\t\"default\": \"Cost Center\",\r\n\t\t\t\t\"reqd\": 1\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"fieldname\": \"fiscal_year\",\r\n\t\t\t\t\"label\": __(\"Fiscal Year\"),\r\n\t\t\t\t\"fieldtype\": \"Link\",\r\n\t\t\t\t\"options\": \"Fiscal Year\",\r\n\t\t\t\t\"default\": frappe.defaults.get_user_default(\"fiscal_year\"),\r\n\t\t\t\t\"reqd\": 1,\r\n\t\t\t\t\"on_change\": function(query_report) {\r\n\t\t\t\t\tvar fiscal_year \u003d query_report.get_values().fiscal_year;\r\n\t\t\t\t\tif (!fiscal_year) {\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tfrappe.model.with_doc(\"Fiscal Year\", fiscal_year, function(r) {\r\n\t\t\t\t\t\tvar fy \u003d frappe.model.get_doc(\"Fiscal Year\", fiscal_year);\r\n\t\t\t\t\t\tfrappe.query_report_filters_by_name.from_date.set_input(fy.year_start_date);\r\n\t\t\t\t\t\tfrappe.query_report_filters_by_name.to_date.set_input(fy.year_end_date);\r\n\t\t\t\t\t\tquery_report.trigger_refresh();\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"fieldname\": \"from_date\",\r\n\t\t\t\t\"label\": __(\"From Date\"),\r\n\t\t\t\t\"fieldtype\": \"Date\",\r\n\t\t\t\t\"default\": frappe.defaults.get_user_default(\"year_start_date\"),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"fieldname\": \"to_date\",\r\n\t\t\t\t\"label\": __(\"To Date\"),\r\n\t\t\t\t\"fieldtype\": \"Date\",\r\n\t\t\t\t\"default\": frappe.defaults.get_user_default(\"year_end_date\"),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t\"fieldname\": \"show_zero_values\",\r\n\t\t\t\t\"label\": __(\"Show zero values\"),\r\n\t\t\t\t\"fieldtype\": \"Check\"\r\n\t\t\t}\r\n\t\t],\r\n\t\t\"formatter\": function(row, cell, value, columnDef, dataContext, default_formatter) {\r\n\t\t\tif (columnDef.df.fieldname\u003d\u003d\"account\") {\r\n\t\t\t\tvalue \u003d dataContext.account_name;\r\n\r\n\t\t\t\tcolumnDef.df.link_onclick \u003d\r\n\t\t\t\t\t\"frappe.query_reports[\u0027Profitability Analysis\u0027].open_profit_and_loss_statement(\" + JSON.stringify(dataContext) + \")\";\r\n\t\t\t\tcolumnDef.df.is_tree \u003d true;\r\n\t\t\t}\r\n\r\n\t\t\tvalue \u003d default_formatter(row, cell, value, columnDef, dataContext);\r\n\r\n\t\t\tif (!dataContext.parent_account \u0026\u0026 dataContext.based_on !\u003d \u0027project\u0027) {\r\n\t\t\t\tvar $value \u003d $(value).css(\"font-weight\", \"bold\");\r\n\t\t\t\tif (dataContext.warn_if_negative \u0026\u0026 dataContext[columnDef.df.fieldname] \u003c 0) {\r\n\t\t\t\t\t$value.addClass(\"text-danger\");\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvalue \u003d $value.wrap(\"\u003cp\u003e\u003c/p\u003e\").parent().html();\r\n\t\t\t}\r\n\r\n\t\t\treturn value;\r\n\t\t},\r\n\t\t\"open_profit_and_loss_statement\": function(data) {\r\n\t\t\tif (!data.account) return;\r\n\r\n\t\t\tfrappe.route_options \u003d {\r\n\t\t\t\t\"company\": frappe.query_report_filters_by_name.company.get_value(),\r\n\t\t\t\t\"from_fiscal_year\": data.fiscal_year,\r\n\t\t\t\t\"to_fiscal_year\": data.fiscal_year\r\n\t\t\t};\r\n\r\n\t\t\tif(data.based_on \u003d\u003d \u0027cost_center\u0027){\r\n\t\t\t\tfrappe.route_options[\"cost_center\"] \u003d data.account\r\n\t\t\t} else {\r\n\t\t\t\tfrappe.route_options[\"project\"] \u003d data.account\r\n\t\t\t}\r\n\r\n\t\t\tfrappe.set_route(\"query-report\", \"Profit and Loss Statement\");\r\n\t\t},\r\n\t\t\"tree\": true,\r\n\t\t\"name_field\": \"account\",\r\n\t\t\"parent_field\": \"parent_account\",\r\n\t\t\"initial_depth\": 3\r\n\t}\r\n});\r\n\r\n","html_format":"{% include \"accounts/report/financial_statements.html\" %}"}}